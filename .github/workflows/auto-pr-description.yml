name: Auto-Update PR Description with Preview URLs

on:
  pull_request:
    types: [opened, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Generate Preview URLs from project.config.json
        id: generate-urls
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          # project.config.jsonã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
          PROJECT_NAME=$(jq -r '.project.name' config/project.config.json)
          EDS_OWNER=$(jq -r '.eds.owner' config/project.config.json)
          
          # AEM.page URL (PSI ãƒã‚§ãƒƒã‚¯ç”¨ - çŸ­ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
          TEST_URL="https://${BRANCH_NAME}--${PROJECT_NAME}--${EDS_OWNER}.aem.page/"
          
          # AEM.live Preview URL (æœ¬ç•ªç”¨ - é•·ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
          SOURCE_URL="https://${BRANCH_NAME}--${PROJECT_NAME}--${EDS_OWNER}.aem.live/"
          TARGET_URL="https://${TARGET_BRANCH}--${PROJECT_NAME}--${EDS_OWNER}.aem.live/"
          
          echo "test_url=${TEST_URL}" >> $GITHUB_OUTPUT
          echo "source_url=${SOURCE_URL}" >> $GITHUB_OUTPUT
          echo "target_url=${TARGET_URL}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generated Preview URLs:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Source Branch: ${BRANCH_NAME}"
          echo "Test URL (PSI): ${TEST_URL}"
          echo "Source URL: ${SOURCE_URL}"
          echo "Target Branch: ${TARGET_BRANCH}"
          echo "Target URL: ${TARGET_URL}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Get current PR body
        id: get-pr-body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const currentBody = pr.body || '';
            core.setOutput('current_body', currentBody);

      - name: Update PR Description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testUrl = '${{ steps.generate-urls.outputs.test_url }}';
            const sourceUrl = '${{ steps.generate-urls.outputs.source_url }}';
            const targetUrl = '${{ steps.generate-urls.outputs.target_url }}';
            const branchName = '${{ steps.generate-urls.outputs.branch_name }}';
            const targetBranch = '${{ steps.generate-urls.outputs.target_branch }}';
            const currentBody = `${{ steps.get-pr-body.outputs.current_body }}`;
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®URLã«ç½®ãæ›ãˆ
            let newBody = currentBody
              .replace(/\{\{BRANCH_NAME\}\}/g, branchName)
              .replace(/https:\/\/\{\{BRANCH_NAME\}\}--[^\/]+\.aem\.page\//g, testUrl)
              .replace(/https:\/\/\{\{BRANCH_NAME\}\}--[^\/]+\.aem\.live\//g, sourceUrl);
            
            // ã‚‚ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆï¼ˆæ‰‹å‹•ã§ä½œæˆã•ã‚ŒãŸPRï¼‰ã€Preview URLã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            if (!newBody.includes('Preview URLs') && !newBody.includes('aem.live') && !newBody.includes('aem.page')) {
              const previewSection = `
            
            ## ğŸ”— Preview URLs
            
            **Test URL:** ${testUrl}
            
            **Source Branch Preview (${branchName}):**
            - ${sourceUrl}
            
            **Target Branch Preview (${targetBranch}):**
            - ${targetUrl}
            `;
              newBody = newBody + previewSection;
            }
            
            // PR Descriptionã‚’æ›´æ–°
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: newBody
            });
            
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ… PR Description updated with Preview URLs');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`Test URL: ${testUrl}`);
            console.log(`Source: ${sourceUrl}`);
            console.log(`Target: ${targetUrl}`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

      - name: Add Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testUrl = '${{ steps.generate-urls.outputs.test_url }}';
            const sourceUrl = '${{ steps.generate-urls.outputs.source_url }}';
            const targetUrl = '${{ steps.generate-urls.outputs.target_url }}';
            const branchName = '${{ steps.generate-urls.outputs.branch_name }}';
            const targetBranch = '${{ steps.generate-urls.outputs.target_branch }}';
            
            const comment = `## ğŸ”— Preview URLs

            Your changes have been deployed to AEM!

            ### ğŸ“‹ Test URL (for PSI check)
            **Test URL:** ${testUrl}

            ### ğŸš€ Preview URLs
            | Branch | Preview URL (aem.live) |
            |--------|------------------------|
            | **${branchName}** (Source) | ${sourceUrl} |
            | **${targetBranch}** (Target) | ${targetUrl} |

            ### ğŸ”— Quick Links
            - [View Test URL (aem.page)](${testUrl}) - Fast updates, shorter cache
            - [View Source Preview (aem.live)](${sourceUrl}) - Production-like
            - [View Target Preview (aem.live)](${targetUrl}) - Current target

            ---
            ğŸ’¡ **URL ã®é•ã„:**
            - \`aem.page\`: é–‹ç™ºç”¨ã€çŸ­ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€PSI ãƒã‚§ãƒƒã‚¯ç”¨
            - \`aem.live\`: æœ¬ç•ªç”¨ã€é•·ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€å®Ÿéš›ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨

            *Preview URLs are automatically generated from project.config.json*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
            
            console.log('âœ… Preview URLs comment added to PR');
