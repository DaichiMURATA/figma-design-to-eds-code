# üö® D2C Repository - Block Generation Rules

**REPOSITORY**: `/Users/dmurata/Documents/Dev/d2c/`
**CRITICAL**: This workspace has multiple repositories. ALL operations MUST be in d2c.

---

## üéØ When User Says: "{BlockName}„Éñ„É≠„ÉÉ„ÇØ„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ"

**THIS IS A TRIGGER - YOU MUST FOLLOW THE WORKFLOW BELOW:**

### MANDATORY 7-Step Workflow

**Step 1: Read config/figma/figma-urls.json**
- Extract ALL variant node IDs for the block
- Example: Carousel has 6 variants

**Step 2: Analyze Figma Structure (API)**
- Call Figma API to get node structure for the first variant
- Extract: component hierarchy, element types, nesting
- Identify: text nodes, image fills, containers, buttons
- Map to HTML structure (semantic elements)
- **CRITICAL**: This determines the HTML structure, NOT the screenshot

**Step 3: Analyze Figma Variables (API)**
- Extract `boundVariables` from Figma API response
- Map Figma variable IDs to CSS variable names in `design-tokens.css`
- Priority: boundVariables > existing tokens > literal values
- **CRITICAL**: Use CSS variables, NOT hardcoded values

**Step 4: Capture ALL Variant Screenshots**
```bash
npm run capture-figma-variant -- --block={blockName} --node-id={nodeId}
```
- Run for EACH variant (e.g., 6 times for Carousel)
- Output: `blocks/{blockName}/figma-variant-{nodeId}.png`

**Step 5: Download Figma Image Assets**
```bash
node scripts/download-figma-assets.js --block={blockName} --node-id={firstNodeId}
```
- Output: `blocks/{blockName}/{blockName}-background.png`

**Step 6: Analyze Screenshots with Vision AI (SUPPLEMENTAL)**
- Use `read_file` tool on the PNG screenshot
- Extract ONLY what Figma API cannot provide:
  - Overlay transparency (rgba alpha values)
  - Subtle color variations
  - Visual positioning nuances
- **DO NOT** extract structure or standard values from screenshot
- **DO NOT** override Figma Variables with hardcoded values

**Step 7: Generate 3 Files**

1. **{blockName}.css**
   - **CRITICAL**: ALL selectors MUST start with `.{blockName}` prefix
     - Correct: `.carousel .carousel-navigation { ... }`
     - Wrong: `.carousel-navigation { ... }`
     - Reason: Prevents style conflicts between blocks and ensures scoping
   - **PRIORITY 1**: Use CSS variables from `design-tokens.css` (check Figma boundVariables)
   - **PRIORITY 2**: Add visual details from Step 6 (transparency, etc.)
   - **PRIORITY 3**: Only use literal values if NO variable exists
   - Add comments: `/* Figma Variable: [variable-name] */` or `/* ÁîªÂÉè„Åã„ÇâÊ§úÂá∫: ... */`
   - **NEVER** hardcode values that have corresponding Figma Variables
   - Reset global styles when needed (e.g., `button { margin: 0; padding: 0; border: none; }`)

2. **{blockName}.js**
   - Follow EDS structure from Step 2 analysis: Block > Rows > Cells
   - Check `config/component/component-definition.json` for `unsafeHTML`
   - Add: `data-block-name="{blockName}"`, `data-block-status="loaded"`
   - Images: `<picture><source type="image/webp"><img loading="lazy">`

3. **{blockName}.stories.js**
   - **CRITICAL**: Import CSS files in correct order:
     ```javascript
     import '../../styles/styles.css';  // Global styles
     import './{blockName}.css';        // Block-specific CSS
     import decorate from './{blockName}.js';
     import bgImage from './{blockName}-background.png';
     ```
   - **CRITICAL**: Minimize Storybook UI elements for visual comparison:
     ```javascript
     export default {
       title: 'Blocks/{BlockName}',
       parameters: {
         layout: 'fullscreen',  // Hide padding/chrome
       },
     };
     // NO 'autodocs' tag
     // NO docs.description
     // NO extra metadata
     ```
   - Reason: Storybook UI elements (titles, docs, tags) create visual differences in Figma comparison
   - Generate ONE story per variant (e.g., 6 stories for Carousel)
   - Add `parameters.design.url` for each story
   - Use same EDS HTML structure as {blockName}.js

**Step 8: Validate**
```bash
npm run validate-block -- --block={blockName}
```
- Validates ALL variants
- Generates HTML report with diff %

**Step 9: Report**
- List generated files
- Figma structure mapping (how API structure mapped to HTML)
- Figma Variables used (list CSS variable mappings)
- Visual details detected from screenshots (RGBA, transparency only)
- Number of variants processed
- Validation results (diff % per variant)

---

## ‚ùå FORBIDDEN

- ‚ùå Skip Figma API structure analysis (Step 2)
- ‚ùå Skip Figma Variables extraction (Step 3)
- ‚ùå Use screenshot to determine HTML structure (use Figma API!)
- ‚ùå Hardcode values that have Figma Variables
- ‚ùå Write CSS selectors without `.{blockName}` prefix
- ‚ùå Forget to import CSS in Stories (must import styles.css and {blockName}.css)
- ‚ùå Add Storybook UI elements (autodocs, docs.description) to Stories
- ‚ùå Skip screenshot capture
- ‚ùå Generate fewer stories than variants
- ‚ùå Skip validation
- ‚ùå Copy code from eds-base-site

---

## üìã Critical Rules: Data Source Priority

### For HTML Structure
1. **PRIMARY**: Figma API structure (node types, hierarchy)
2. **SECONDARY**: EDS conventions (`component-definition.json`)
3. **NEVER**: Screenshot analysis

### For CSS Values
1. **PRIORITY 1**: Figma Variables ‚Üí CSS variables in `design-tokens.css`
2. **PRIORITY 2**: Screenshot analysis (transparency, visual nuances)
3. **PRIORITY 3**: Literal values (ONLY if no variable exists)

### Decision Tree: "Should I use a CSS variable?"
```
Is there a Figma boundVariable? 
  ‚Üí YES: Use corresponding CSS variable from design-tokens.css
  ‚Üí NO: Is this a color/spacing/size that might be a design token?
    ‚Üí YES: Check design-tokens.css, use if exists
    ‚Üí NO: Use literal value + document reason
```

---

## üìã EDS HTML Structure Example

```html
<div class="carousel" data-block-name="carousel" data-block-status="loaded">
  <div> <!-- Row -->
    <div> <!-- Cell 1: Image -->
      <picture>
        <source type="image/webp" srcset="...">
        <img loading="lazy" src="...">
      </picture>
    </div>
    <div> <!-- Cell 2: Content -->
      <h2>Heading</h2>
      <p>Text</p>
    </div>
  </div>
</div>
```

**CSS Scoping Rule**:
- ‚úÖ Correct: `.carousel .carousel-slide { ... }`
- ‚ùå Wrong: `.carousel-slide { ... }` (no block prefix)

This ensures:
- No style conflicts between blocks
- Proper CSS specificity
- Storybook isolation

---

## üìö Documentation

- Full workflow details: `docs/VISION-AI-ENHANCED-GENERATION.md`
- Prompt templates: `prompts/vision-*.md`
- Figma variant mapping: `config/figma/figma-urls.json`
- Component definitions: `config/component/component-definition.json`

---

## üé® Design System

- **Design Tokens**: `styles/design-tokens.css`
- **Font**: Noto Sans JP (universal)
- **CSS Variables**: Use CSS custom properties (no hardcoded values)
- **Responsive**: Follow Figma responsive tokens

---

## ‚úÖ Success Criteria

Before reporting completion, verify:
- [ ] Figma API structure analyzed (Step 2)
- [ ] Figma Variables (boundVariables) extracted (Step 3)
- [ ] All variant screenshots captured
- [ ] Screenshot analyzed for supplemental details only (transparency, etc.)
- [ ] **CSS selectors ALL start with `.{blockName}` prefix**
- [ ] CSS uses CSS variables for ALL Figma Variables (NO hardcoded values)
- [ ] CSS has `/* Figma Variable: ... */` or `/* ÁîªÂÉè„Åã„ÇâÊ§úÂá∫: ... */` comments
- [ ] CSS resets global styles where needed (button, etc.)
- [ ] **Stories import CSS files (styles.css + {blockName}.css)**
- [ ] **Stories have NO autodocs, NO docs.description (minimal UI)**
- [ ] JS follows EDS structure from Figma API + `component-definition.json`
- [ ] Stories generated for ALL variants (1:1 mapping)
- [ ] Each story has correct Figma URL
- [ ] Validation ran for all variants
- [ ] Diff % reported per variant

---

**Note**: This is the COMPLETE workflow. Do NOT skip steps. Do NOT reference eds-base-site code.
